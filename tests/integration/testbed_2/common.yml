---
- hosts: all
  become: true
  become_method: sudo
  gather_facts: true
  tasks:
    - name: Create terminfo dir
      ansible.builtin.command:
        cmd: mkdir -p /home/vagrant/.terminfo/x
      become_user: vagrant

    - name: Copy xterm-kitty terminfo file
      ansible.builtin.copy:
        dest: /home/vagrant/.terminfo/x
        src: xterm-kitty
      become_user: vagrant


    - name: Update cache
      ansible.builtin.apt:
        update_cache: true

    # See https://docs.frrouting.org/projects/dev-guide/en/latest/topotests.html#installation-and-setup
    - name: Install necessary packages
      ansible.builtin.apt:
        pkg:
          - tmux
          - gpg
          - tcpdump
          - git
          - gdb
          - iproute2
          - net-tools
          - python3-pip

    - name: Install necessary python packages
      ansible.builtin.pip:
        executable: pip3
        name:
          - wheel
          - 'pytest>=6.2.4'
          - 'pytest-xdist>=2.3.0'
          - 'scapy>=2.4.5'
          - xmltodict

    - name: Clone FRRouting git repo
      ansible.builtin.git:
        dest: /home/vagrant/frr
        repo: https://github.com/FRRouting/frr.git
        version: frr-8.1

    - name: Move tests to separate directory
      ansible.builtin.command:
        cmd: mv /home/vagrant/frr/tests/topotests /home/vagrant/frr-topology-tests
        removes: /home/vagrant/frr/tests/topotests

    - name: Remove FRRouting git repo
      ansible.builtin.command:
        cmd: rm -r /home/vagrant/frr
        removes: /home/vagrant/frr

    - name: Add frrouting repo key
      ansible.builtin.apt_key:
        url: https://deb.frrouting.org/frr/keys.asc
        state: present

    - name: Add frrouting repo
      ansible.builtin.apt_repository:
        repo: deb https://deb.frrouting.org/frr bullseye frr-8
        state: present

    - name: Install frrouting
      ansible.builtin.apt:
        pkg:
          - frr
          - frr-pythontools

    - name: Configure ip forwarding
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: 1
        state: present
        sysctl_set: true
        reload: true
      loop:
        - net.ipv4.conf.all.forwarding
        - net.ipv6.conf.all.forwarding

    - name: Load mpls modules
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - mpls_router
        - mpls_iptunnel

    - name: Configure mpls forwarding
      ansible.posix.sysctl:
        name: "net.mpls.conf.{{ item }}.input"
        value: 1
        state: present
        sysctl_set: true
        reload: true
      loop: "{{ ansible_interfaces }}"
